<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>üéÑ Xmas Interactive ‚Äî iPhone Edition</title>

<style>
body{margin:0;background:black;overflow:hidden;touch-action:none;-webkit-user-select:none;font-family:-apple-system,BlinkMacSystemFont,Arial;}
#loading{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  color:white;font-size:22px;text-align:center;
}
#ui{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  display:flex;gap:10px;z-index:50;
}
button{
  font-size:16px;padding:12px 18px;border-radius:12px;
  border:0;background:#d4af37;color:black;
}
.hidden{opacity:0;pointer-events:none;transition:0.35s;}
/* ===== Instagram Viewer ===== */
#photoPreview{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:72vw;height:72vw;max-width:380px;border-radius:22px;
  overflow:hidden;background:rgba(255,255,255,0.05);
  border:3px solid #d4af37;box-shadow:0 0 25px rgba(212,175,55,0.28);
  backdrop-filter:blur(20px) brightness(1.1);
  display:flex;justify-content:center;align-items:center;
  z-index:200;
}
#photoPreview.hidden{opacity:0;pointer-events:none;}
#previewImg{width:100%;height:100%;object-fit:cover;border-radius:20px;}
#photoPreview::after{
 content:"";position:absolute;inset:0;
 background:radial-gradient(circle,rgba(0,0,0,0) 55%,rgba(0,0,0,0.45) 100%);
 pointer-events:none;
}
</style>
</head>

<body>

<div id="loading">‚è≥ Loading‚Ä¶<br>Optimizing for iPhone‚Ä¶</div>

<div id="ui">
 <button id="btnStart">Start üéÑ</button>
 <button id="btnTree">üéÑ</button>
 <button id="btnScatter">‚ú®</button>
 <button id="btnGallery">üñº</button>
 <button id="btnPhoto">üì∑</button>
 <button id="btnMusic">üéµ</button>
 <button id="btnFX">üéÜ</button>
</div>

<audio id="bgm" loop></audio>
<input id="photoInput" type="file" accept="image/*" style="display:none;">
<div id="photoPreview" class="hidden"><img id="previewImg"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>

/* ========= DEVICE SETTINGS ========= */
const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
const PARTICLES = isiOS ? 350 : 1800;

/* ========= GLOBAL STATE ========= */
let scene, camera, renderer, particles;
let audioContext=null, analyser=null, dataArray=null;
let mode = "scatter";

/* ========= AUDIO UNLOCK ========= */
async function enableAudio(){
 if(!audioContext){
   audioContext=new (window.AudioContext||window.webkitAudioContext)();
 }
 if(audioContext.state==="suspended") await audioContext.resume();
 if(!analyser){
    analyser=audioContext.createAnalyser();
    analyser.fftSize=256;
    dataArray=new Uint8Array(analyser.frequencyBinCount);
    const src=audioContext.createMediaElementSource(bgm);
    src.connect(analyser);analyser.connect(audioContext.destination);
 }
}

/* ========= MUSIC CONTROL ========= */
const bgm=document.getElementById("bgm");
let musicPlaying=false;

btnMusic.onclick=async()=>{
  await enableAudio();
  if(!bgm.src){
   bgm.src="https://cdn.pixabay.com/audio/2023/11/08/audio_42f3b8e665.mp3";
  }
  if(!musicPlaying){
    await bgm.play();
    musicPlaying=true;
    btnMusic.innerText="‚è∏";
  }else{
    bgm.pause();
    musicPlaying=false;
    btnMusic.innerText="üéµ";
  }
};

/* ========= THREE.JS CORE ========= */

function initScene(){
 scene=new THREE.Scene();
 camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.1,1000);
 camera.position.z=isiOS?12:9;

 renderer=new THREE.WebGLRenderer({
   antialias:false,alpha:true,powerPreference:"low-power"
 });
 renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.4));
 renderer.setSize(window.innerWidth,window.innerHeight);
 document.body.appendChild(renderer.domElement);

 createParticles();
 animate();
}

function createParticles(){
 const geo=new THREE.BufferGeometry();
 const pos=new Float32Array(PARTICLES*3);
 for(let i=0;i<pos.length;i++) pos[i]=(Math.random()-0.5)*18;

 geo.setAttribute("position",new THREE.BufferAttribute(pos,3));

 const mat=new THREE.PointsMaterial({
   color:0xd4af37,size:isiOS?0.18:0.1,transparent:true
 });

 particles=new THREE.Points(geo,mat);
 scene.add(particles);
}

function animate(){
 requestAnimationFrame(animate);

 if(particles){
    if(mode==="scatter") particles.rotation.y+=0.003;
    if(musicPlaying && analyser){
      analyser.getByteFrequencyData(dataArray);
      particles.material.size= (isiOS?0.18:0.1) + (dataArray[12]/255)*0.12;
    }
 }

 renderer.render(scene,camera);
}

/* ========= SHAPE MODES ========= */

btnScatter.onclick=()=>{
 mode="scatter";
 randomizeParticles();
};

btnTree.onclick=()=>{
 mode="tree";
 christmasTree();
};

function randomizeParticles(){
 const arr=particles.geometry.attributes.position.array;
 for(let i=0;i<arr.length;i++) arr[i]=(Math.random()-0.5)*18;
 particles.geometry.attributes.position.needsUpdate=true;
}

function christmasTree(){
 const arr=particles.geometry.attributes.position.array;
 for(let i=0;i<PARTICLES;i++){
   const h=i/PARTICLES;
   const r=(1-h)*2;
   const angle=Math.random()*Math.PI*2;
   arr[i*3]=Math.cos(angle)*r;
   arr[i*3+1]=h*5-2.5;
   arr[i*3+2]=Math.sin(angle)*r;
 }
 particles.geometry.attributes.position.needsUpdate=true;
}

/* ========= FIREWORKS ========= */
btnFX.onclick=()=>{
 createFirework();
};

function createFirework(){
 for(let i=0;i<20;i++){
  setTimeout(()=>explode(), i*80);
 }
}

function explode(){
 const g=new THREE.BufferGeometry();
 const p=[];
 for(let i=0;i<50;i++){
  const a=Math.random()*Math.PI*2;
  const b=Math.random()*Math.PI;
  const s=Math.random()*0.25;
  p.push(Math.sin(b)*Math.cos(a)*s,Math.sin(b)*Math.sin(a)*s,Math.cos(b)*s);
 }
 g.setAttribute("position",new THREE.Float32BufferAttribute(p,3));
 const m=new THREE.PointsMaterial({color:0xffcc66,size:0.15});
 const fw=new THREE.Points(g,m);
 scene.add(fw);
 setTimeout(()=>scene.remove(fw),1500);
}

/* ========= PHOTO SYSTEM ========= */

btnPhoto.onclick=()=> photoInput.click();
const photoPreview=document.getElementById("photoPreview");
const previewImg=document.getElementById("previewImg");

photoInput.onchange=(e)=> {
 const file=e.target.files[0];
 if(!file)return;
 const url=URL.createObjectURL(file);
 previewImg.src=url;
 photoPreview.classList.remove("hidden");
};

photoPreview.onclick=()=> photoPreview.classList.add("hidden");

/* Pinch zoom */
let startDist=null,baseScale=1;

photoPreview.addEventListener("touchstart",(e)=>{
 if(e.touches.length===2){
  startDist=Math.hypot(
    e.touches[0].clientX-e.touches[1].clientX,
    e.touches[0].clientY=e.touches[1].clientY
  );
 }
},{passive:false});

photoPreview.addEventListener("touchmove",(e)=>{
 if(e.touches.length===2 && startDist){
  e.preventDefault();
  const newDist=Math.hypot(
    e.touches[0].clientX-e.touches[1].clientX,
    e.touches[0].clientY-e.touches[1].clientY
  );
  const scale=Math.min(3,Math.max(0.7,(newDist/startDist)*baseScale));
  previewImg.style.transform=`scale(${scale})`;
 }
},{passive:false});

photoPreview.addEventListener("touchend",()=>{
 baseScale=parseFloat(previewImg.style.transform.replace("scale(","").replace(")",""))||1;
});

/* ========= GALLERY (simple grid prototype) ========= */
btnGallery.onclick=()=>{
 alert("üìå Gallery mode incoming ‚Äî planned next update.\n(Will use Insta grid with Gold-tone frame.)");
};

/* ========= START ========= */
btnStart.onclick=()=>{
 document.getElementById("loading").remove();
 initScene();
};

/* Fix Safari zoom gestures */
document.addEventListener("gesturestart",e=>e.preventDefault());
document.addEventListener("gesturechange",e=>e.preventDefault());
document.addEventListener("gestureend",e=>e.preventDefault());

</script>
</body>
</html>
