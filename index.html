<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Minimalist Xmas Tree</title>
    <style>
        /* === æç®€é»‘é‡‘ç¾å­¦ === */
        body { 
            margin: 0; 
            background-color: #050505; /* æ·±é‚ƒé»‘ */
            overflow: hidden; 
            font-family: sans-serif;
            touch-action: none; 
            cursor: pointer; /* æç¤ºå¯ç‚¹å‡» */
        }

        /* å”¯ä¸€çš„æŒ‰é’®ï¼šä¸Šä¼ ç…§ç‰‡ */
        #photo-btn {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(20, 20, 20, 0.6);
            border: 1px solid rgba(212, 175, 55, 0.5); /* é‡‘è‰²è¾¹æ¡† */
            color: #d4af37;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            z-index: 100;
            transition: all 0.3s ease;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        #photo-btn:active {
            transform: translateX(-50%) scale(0.9);
            background: rgba(212, 175, 55, 0.2);
        }

        /* æç¤ºæ–‡å­— */
        #hint {
            position: absolute;
            top: 45%;
            left: 0; right: 0;
            text-align: center;
            color: #d4af37;
            opacity: 0.6;
            pointer-events: none;
            font-size: 14px;
            letter-spacing: 2px;
            animation: fadeOut 4s forwards;
        }

        @keyframes fadeOut { 
            0% {opacity: 0;} 
            20% {opacity: 0.8;} 
            80% {opacity: 0.8;} 
            100% {opacity: 0;} 
        }
    </style>
</head>
<body>

    <div id="hint">ç‚¹å‡»å±å¹•åˆ‡æ¢å½¢çŠ¶<br>TAP TO TRANSFORM</div>

    <button id="photo-btn">ğŸ“·</button>
    <input type="file" id="file-input" accept="image/*" style="display:none">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // === 1. åˆå§‹åŒ–åœºæ™¯ ===
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.04);

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 12; // ç›¸æœºè·ç¦»

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        // === 2. ç²’å­ç³»ç»Ÿé…ç½® ===
        // æ‰‹æœºç«¯å‡å°‘ç²’å­æ•°ä»¥ä¿è¯æµç•…ï¼Œç”µè„‘ç«¯æ›´å¤š
        const isMobile = window.innerWidth < 768;
        const count = isMobile ? 1200 : 3000; 
        
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(count * 3);
        const targets = new Float32Array(count * 3); // ç›®æ ‡ä½ç½®å­˜å‚¨
        
        // åˆå§‹åŒ–ä¸ºâ€œæ•£å¼€â€çŠ¶æ€
        for(let i=0; i<count; i++) {
            positions[i*3] = (Math.random()-0.5) * 25;
            positions[i*3+1] = (Math.random()-0.5) * 25;
            positions[i*3+2] = (Math.random()-0.5) * 15;
        }
        
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        
        // é‡‘è‰²æè´¨
        const material = new THREE.PointsMaterial({
            color: 0xffd700,
            size: isMobile ? 0.18 : 0.12,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending
        });

        const particles = new THREE.Points(geometry, material);
        scene.add(particles);

        // === 3. äº¤äº’é€»è¾‘ ===
        let isTree = false;
        let photoMesh = null;

        // è®¡ç®—ä¸åŒå½¢çŠ¶çš„ç›®æ ‡ä½ç½®
        function calculateTargets() {
            if(isTree) {
                // åœ£è¯æ ‘å½¢çŠ¶
                for(let i=0; i<count; i++) {
                    const i3 = i*3;
                    const h = i/count; // 0 åˆ° 1
                    const angle = i * 0.5; 
                    const r = (1-h) * 4.5; // åŠå¾„

                    targets[i3] = Math.cos(angle) * r;
                    targets[i3+1] = (h * 9) - 4.5; // é«˜åº¦æ‹‰ä¼¸
                    targets[i3+2] = Math.sin(angle) * r;
                }
            } else {
                // æ˜Ÿç©ºæ•£å¼€å½¢çŠ¶
                for(let i=0; i<count; i++) {
                    const i3 = i*3;
                    targets[i3] = (Math.random()-0.5) * 25;
                    targets[i3+1] = (Math.random()-0.5) * 25;
                    targets[i3+2] = (Math.random()-0.5) * 15;
                }
            }
        }
        
        // åˆå§‹ç›®æ ‡
        calculateTargets();

        // ç‚¹å‡»å±å¹•åˆ‡æ¢ (æ’é™¤æŒ‰é’®ç‚¹å‡»)
        document.addEventListener('click', (e) => {
            if(e.target.id === 'photo-btn' || e.target.id === 'file-input') return;
            isTree = !isTree;
            calculateTargets();
        });

        // === 4. ç…§ç‰‡ä¸Šä¼ åŠŸèƒ½ ===
        const btn = document.getElementById('photo-btn');
        const input = document.getElementById('file-input');

        btn.addEventListener('click', () => input.click());

        input.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    // ç§»é™¤æ—§ç…§ç‰‡
                    if(photoMesh) scene.remove(photoMesh);
                    
                    // åˆ›å»ºæ–°ç…§ç‰‡
                    const tex = new THREE.TextureLoader().load(img.src);
                    const aspect = img.width / img.height;
                    // é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢ç…§ç‰‡è¿‡å¤§
                    const w = 5; 
                    const h = w / aspect;
                    
                    const mat = new THREE.MeshBasicMaterial({ 
                        map: tex, 
                        side: THREE.DoubleSide,
                        transparent: true,
                        opacity: 0.95
                    });
                    const geo = new THREE.PlaneGeometry(w, h);
                    
                    photoMesh = new THREE.Mesh(geo, mat);
                    scene.add(photoMesh);
                    
                    // ä¸Šä¼ åè‡ªåŠ¨å˜æˆæ ‘å½¢åŒ…è£¹ç…§ç‰‡
                    if(!isTree) {
                        isTree = true;
                        calculateTargets();
                    }
                };
            };
            reader.readAsDataURL(file);
        });

        // === 5. åŠ¨ç”»å¾ªç¯ ===
        function animate() {
            requestAnimationFrame(animate);

            const pos = particles.geometry.attributes.position.array;
            
            // ç²’å­ç§»åŠ¨æ’å€¼ (Lerp)
            for(let i=0; i<count*3; i++) {
                pos[i] += (targets[i] - pos[i]) * 0.06; // 0.06 æ˜¯èšåˆé€Ÿåº¦
            }
            particles.geometry.attributes.position.needsUpdate = true;

            // æ•´ä½“æ—‹è½¬
            const time = Date.now() * 0.0005;
            scene.rotation.y = time * 0.5; // ç¼“æ…¢è‡ªè½¬

            // è®©ç…§ç‰‡å§‹ç»ˆé¢å‘ç›¸æœº (Billboardæ•ˆæœ)
            if(photoMesh) {
                photoMesh.rotation.y = -scene.rotation.y; 
            }

            renderer.render(scene, camera);
        }

        animate();

        // çª—å£è°ƒæ•´
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>