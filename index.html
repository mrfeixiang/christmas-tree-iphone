<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fei's Magic Tree</title>
    <style>
        /* --- æç®€é»‘é‡‘ç¾å­¦ --- */
        body { 
            margin: 0; 
            background-color: #000; 
            overflow: hidden; 
            font-family: 'Helvetica Neue', sans-serif;
            touch-action: none; /* ç¦æ­¢æ‰‹æœºé»˜è®¤ç¼©æ”¾ */
        }

        /* æç¤ºè¯­ (ç‚¹å‡»åæ¶ˆå¤±) */
        #hint {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #d4af37; /* é‡‘è‰² */
            font-size: 1.2rem;
            opacity: 0.8;
            pointer-events: none;
            text-align: center;
            animation: pulse 2s infinite;
            transition: opacity 0.5s;
        }

        /* åº•éƒ¨æç®€å·¥å…·æ  */
        #toolbar {
            position: absolute;
            bottom: 30px;
            left: 0; right: 0;
            display: flex;
            justify-content: center;
            gap: 40px;
            z-index: 100;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #d4af37;
            width: 50px; height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s, background 0.2s;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .icon-btn:active { transform: scale(0.9); background: rgba(212, 175, 55, 0.2); }

        @keyframes pulse { 0%{opacity:0.4} 50%{opacity:1} 100%{opacity:0.4} }
    </style>
</head>
<body>

    <div id="hint">Tap anywhere to transform<br><span style="font-size:0.8em">ç‚¹å‡»å±å¹•å˜æ¢å½¢çŠ¶</span></div>

    <div id="toolbar">
        <button class="icon-btn" id="btnMusic">ğŸµ</button>
        <button class="icon-btn" id="btnPhoto">ğŸ“·</button>
    </div>

    <input type="file" id="fileInput" accept="image/*" style="display:none">
    
    <audio id="bgm" src="https://cdn.pixabay.com/audio/2023/11/08/audio_42f3b8e665.mp3" loop></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        /* === 1. åˆå§‹åŒ–è®¾ç½® === */
        const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);
        const particleCount = isMobile ? 800 : 2000; // æ‰‹æœºç«¯å‡å°‘ç²’å­ä»¥ä¿è¯æµç•…
        
        let scene, camera, renderer, particles, photoMesh;
        let isTreeMode = false; // å½“å‰çŠ¶æ€æ ‡è®°

        // å¯åŠ¨åœºæ™¯
        init();
        animate();

        function init() {
            // åœºæ™¯
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.05); // é»‘è‰²è¿·é›¾å¢åŠ æ·±é‚ƒæ„Ÿ

            // ç›¸æœº
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 10;
            camera.position.y = 2;

            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            // åˆ›å»ºé‡‘è‰²ç²’å­
            createParticles();

            // äº¤äº’äº‹ä»¶
            window.addEventListener('resize', onWindowResize, false);
            // ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®åˆ‡æ¢å½¢çŠ¶
            document.addEventListener('click', (e) => {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸è¦åˆ‡æ¢å½¢çŠ¶
                if(e.target.closest('button')) return;
                toggleShape();
            });
        }

        /* === 2. ç²’å­ç³»ç»Ÿ === */
        function createParticles() {
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const targetPositions = new Float32Array(particleCount * 3); // å­˜å‚¨ç›®æ ‡ä½ç½®

            // åˆå§‹åŒ–ä¸ºâ€œæ˜Ÿæ²³â€æ•£å¼€çŠ¶æ€
            for (let i = 0; i < particleCount; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 20;
                positions[i * 3 + 1] = (Math.random() - 0.5) * 20;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 10;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            // å­˜å‚¨ä¸€ä¸ªâ€œç›®æ ‡â€å±æ€§ç”¨äºåŠ¨ç”»è¿‡æ¸¡
            geometry.setAttribute('target', new THREE.BufferAttribute(positions.slice(), 3));

            // é‡‘è‰²æè´¨
            const material = new THREE.PointsMaterial({
                color: 0xffd700,
                size: isMobile ? 0.15 : 0.1,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        /* === 3. æ ¸å¿ƒé€»è¾‘ï¼šåˆ‡æ¢å½¢çŠ¶ === */
        function toggleShape() {
            isTreeMode = !isTreeMode;
            
            // éšè—æç¤ºè¯­
            const hint = document.getElementById('hint');
            if(hint) hint.style.opacity = 0;

            const targets = particles.geometry.attributes.target.array;

            if (isTreeMode) {
                // === è®¡ç®—åœ£è¯æ ‘å½¢çŠ¶ ===
                for (let i = 0; i < particleCount; i++) {
                    const i3 = i * 3;
                    const h = i / particleCount; // é«˜åº¦ 0 åˆ° 1
                    const angle = i * 0.5; // èºæ—‹è§’åº¦
                    const r = (1 - h) * 3.5; // åº•éƒ¨å®½ï¼Œé¡¶éƒ¨å°–

                    targets[i3] = Math.cos(angle) * r;     // X
                    targets[i3 + 1] = (h * 7) - 3.5;       // Y (æ‹‰é«˜æ ‘èº«)
                    targets[i3 + 2] = Math.sin(angle) * r; // Z
                }
            } else {
                // === è®¡ç®—æ˜Ÿæ²³æ•£å¼€å½¢çŠ¶ ===
                for (let i = 0; i < particleCount; i++) {
                    const i3 = i * 3;
                    targets[i3] = (Math.random() - 0.5) * 15;
                    targets[i3 + 1] = (Math.random() - 0.5) * 15;
                    targets[i3 + 2] = (Math.random() - 0.5) * 10;
                }
            }
        }

        /* === 4. åŠ¨ç”»å¾ªç¯ === */
        function animate() {
            requestAnimationFrame(animate);

            // ç²’å­ç¼“åŠ¨åŠ¨ç”» (Lerp)
            const positions = particles.geometry.attributes.position.array;
            const targets = particles.geometry.attributes.target.array;
            
            for (let i = 0; i < positions.length; i++) {
                // è®©å½“å‰ä½ç½®æ…¢æ…¢æ¥è¿‘ç›®æ ‡ä½ç½® (0.05 æ˜¯ç§»åŠ¨é€Ÿåº¦)
                positions[i] += (targets[i] - positions[i]) * 0.05;
            }
            particles.geometry.attributes.position.needsUpdate = true;

            // æ•´ä½“ç¼“æ…¢æ—‹è½¬
            particles.rotation.y += 0.002;
            if(photoMesh) photoMesh.rotation.y = particles.rotation.y; // ç…§ç‰‡è·Ÿéšæ—‹è½¬

            renderer.render(scene, camera);
        }

        /* === 5. åŠŸèƒ½é€»è¾‘ï¼šéŸ³ä¹ä¸ç…§ç‰‡ === */
        
        // éŸ³ä¹å¼€å…³
        const btnMusic = document.getElementById('btnMusic');
        const bgm = document.getElementById('bgm');
        let isPlaying = false;

        btnMusic.addEventListener('click', () => {
            if (isPlaying) {
                bgm.pause();
                btnMusic.textContent = "ğŸµ";
                btnMusic.style.background = "rgba(255,255,255,0.1)";
            } else {
                bgm.play();
                btnMusic.textContent = "â¸";
                btnMusic.style.background = "rgba(212,175,55,0.4)"; // æ¿€æ´»å˜æˆé‡‘è‰²èƒŒæ™¯
            }
            isPlaying = !isPlaying;
        });

        // ç…§ç‰‡ä¸Šä¼ 
        const btnPhoto = document.getElementById('btnPhoto');
        const fileInput = document.getElementById('fileInput');

        btnPhoto.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    createPhotoInScene(img);
                };
            };
            reader.readAsDataURL(file);
        });

        function createPhotoInScene(imageElement) {
            // å¦‚æœå·²æœ‰ç…§ç‰‡ï¼Œå…ˆç§»é™¤
            if (photoMesh) scene.remove(photoMesh);

            const texture = new THREE.TextureLoader().load(imageElement.src);
            // ä¿æŒå®½é«˜æ¯”ï¼Œå›ºå®šé«˜åº¦ä¸º 4
            const aspect = imageElement.width / imageElement.height;
            const geometry = new THREE.PlaneGeometry(4 * aspect, 4);
            
            const material = new THREE.MeshBasicMaterial({ 
                map: texture, 
                side: THREE.DoubleSide, 
                transparent: true,
                opacity: 0.9 
            });

            photoMesh = new THREE.Mesh(geometry, material);
            scene.add(photoMesh);
            
            // åˆ‡æ¢åˆ°æ ‘æ¨¡å¼ä»¥åŒ…å›´ç…§ç‰‡
            if(!isTreeMode) toggleShape();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>